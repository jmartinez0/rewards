generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

model Config {
  id             Int      @id @default(autoincrement())
  centsToOneUsd  Int      @default(0)
  expirationDays Int?
  isActive       Boolean  @default(true)
  updatedAt      DateTime @updatedAt
}

model Customer {
  id                   Int           @id @default(autoincrement())
  email                String        @unique
  name                 String
  shopifyCustomerId    String?       @unique
  currentRewardsCents  Int           @default(0)
  lifetimeRewardsCents Int           @default(0)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  ledgerEntries        LedgerEntry[]
}

model LedgerEntry {
  id                    Int           @id @default(autoincrement())
  customerId            Int
  type                  LedgerType
  rewardsDeltaCents     Int
  remainingRewardsCents Int?
  centsToOneUsd         Int?
  expiresAt             DateTime?
  orderId               String?
  sourceLotId           Int?
  adjustmentGroupId     String?       @db.Uuid
  adjustedByEmail       String?
  notes                 String?
  createdAt             DateTime      @default(now())
  customer              Customer      @relation(fields: [customerId], references: [id])
  sourceLot             LedgerEntry?  @relation("RelatedEarn", fields: [sourceLotId], references: [id])
  depletions            LedgerEntry[] @relation("RelatedEarn")
}

model Discount {
  id                      Int      @id @default(autoincrement())
  shopifyCustomerId       String   @unique
  automaticDiscountNodeId String
  discountTitle           String
  createdAt               DateTime @default(now())
}

enum LedgerType {
  EARN
  SPEND
  ADJUST
  EXPIRE
}
